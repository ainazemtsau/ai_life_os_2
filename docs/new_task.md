ЭТАП 1.1: Onboarding Workflow — Полная логика
Цель этапа
Реализовать полноценный Onboarding Workflow с правильными переходами между шагами, критериями завершения каждого шага, и корректной работой всех 4-х агентов.

Что должно работать в конце этапа

User начинает диалог → попадает на шаг greeting
Greeter представляет систему → когда user понял, переход на discovery
Discovery выясняет приоритеты → когда достаточно информации, переход на brain_dump
Inbox Collector предлагает выгрузить мысли → когда user закончил, переход на setup_complete
На каждом шаге работает правильный агент
Переходы происходят автоматически по критериям (решает агент)
Нельзя перескочить шаг — workflow контролирует порядок


Компонент 1: Конфигурация шагов workflow
Требования
Каждый шаг должен иметь:

agent_slug — какой агент работает на этом шаге
completion_criteria — описание когда шаг считается завершённым
next_step — на какой шаг переходить
is_required — можно ли пропустить (все шаги onboarding обязательны)
min_messages — минимальное количество обменов до возможного завершения
max_messages — максимальное количество (после — принудительный переход)

Шаги Onboarding
ШагАгентКритерий завершенияMin/MaxgreetinggreeterUser понял что это за система, готов продолжить2/10discoverydiscoveryСобрано достаточно информации о приоритетах (min 3 области жизни)5/30brain_dumpinbox_collectorUser выгрузил мысли (min 3 items в inbox)3/20setup_completecoordinatorФинальное сообщение, workflow завершён1/1

Компонент 2: Логика переходов
Требования

Агент решает о завершении шага — в ответе агента должен быть сигнал step_completed: true/false
Workflow проверяет критерии:

Достигнут min_messages?
Агент сигнализировал о завершении?
Есть необходимые данные? (для discovery — память, для brain_dump — inbox items)


Автоматический переход — если все критерии выполнены, workflow переходит на следующий шаг
Принудительный переход — если достигнут max_messages, переход независимо от сигнала агента
Сохранение контекста — при переходе на новый шаг, контекст предыдущего передаётся


Компонент 3: Greeter Agent — логика завершения
Требования

Greeter должен:

Представить систему (что это, зачем, как работает)
Объяснить процесс onboarding
Убедиться что user готов продолжить


Критерий завершения:

User явно подтвердил готовность ("понял", "давай", "поехали", "готов")
ИЛИ user задал вопрос о следующем шаге
ИЛИ прошло 3+ обмена и user не выражает непонимание


Сигнал завершения:

Агент должен вернуть step_completed: true когда считает что можно переходить




Компонент 4: Discovery Agent — логика завершения
Требования

Discovery должен:

Выяснить основные области жизни (работа, здоровье, отношения, развитие, хобби)
Понять приоритеты между ними
Узнать текущую ситуацию и constraints
Сохранять факты в Mem0 после каждого обмена


Критерий завершения:

Собрано минимум 3 области жизни с описанием
User подтвердил что система правильно поняла приоритеты
ИЛИ агент уверен на 80%+ что понимание достаточное


Проверка через Mem0:

Перед сигналом завершения — query к Mem0 на наличие приоритетов
Если в памяти меньше 3 фактов о приоритетах — не завершать


Сводка перед переходом:

Discovery должен показать user'у "вот что я понял о тебе"
User подтверждает или корректирует




Компонент 5: Inbox Collector Agent — логика завершения
Требования

Inbox Collector должен:

Объяснить зачем выгружать мысли
Помочь user'у вспомнить всё что "висит в голове"
Записывать каждую мысль/желание в inbox


Сбор через диалог (без widget — widget будет в 1.5):

User пишет мысли в чат
Агент парсит и сохраняет в inbox_items
Подтверждает что записал


Критерий завершения:

Минимум 3 items в inbox
User сказал что всё ("это всё", "больше ничего", "готово")


Проверка через БД:

Query на количество inbox_items для user
Если меньше 3 — не завершать, попросить ещё




Компонент 6: Coordinator Agent — финализация
Требования

После brain_dump Coordinator:

Поздравляет с завершением onboarding
Показывает краткую сводку (сколько приоритетов, сколько мыслей в inbox)
Объясняет что будет дальше


Workflow завершается:

Статус workflow → completed
Сохранение в БД




Компонент 7: Формат ответа агента (обновление)
Требования
Каждый агент должен возвращать структурированный ответ:
{
  "message": "текст для user",
  "step_completed": true/false,
  "completion_reason": "user_confirmed" | "criteria_met" | "max_reached" | null,
  "extracted_data": {
    // данные для сохранения (inbox items, facts, etc.)
  },
  "next_action": "continue" | "transition" | "wait_for_input"
}

Компонент 8: Счётчик сообщений
Требования

Workflow отслеживает количество сообщений на каждом шаге
При достижении max_messages — принудительный переход с предупреждением
Счётчик сбрасывается при переходе на новый шаг


Компонент 9: Сохранение inbox items
Требования

При получении мыслей от user — парсинг и сохранение в inbox_items
Каждый item:

content — текст
source — "onboarding"
status — "new"
created_at


Агент подтверждает сохранение user'у


Компонент 10: API для получения прогресса
Требования

Endpoint должен возвращать:

current_step — на каком шаге
steps — список всех шагов с их статусами
messages_in_step — сколько сообщений на текущем шаге
completion_percentage — общий прогресс (0-100%)




Критерии завершения ЭТАПА 1.1
Логика переходов

 Workflow стартует с шага greeting
 Переход greeting → discovery работает по сигналу агента
 Переход discovery → brain_dump работает по сигналу + проверка Mem0
 Переход brain_dump → setup_complete работает по сигналу + проверка inbox
 Принудительный переход при max_messages работает

Агенты

 Greeter корректно определяет готовность user
 Discovery сохраняет факты в Mem0
 Discovery показывает сводку перед переходом
 Inbox Collector парсит и сохраняет items
 Coordinator завершает workflow корректно

Данные

 Счётчик сообщений работает
 Inbox items сохраняются в БД
 Факты сохраняются в Mem0
 Прогресс доступен через API

Тесты

 Можно пройти весь onboarding от начала до конца
 Нельзя перескочить шаг
 При перезапуске backend — workflow продолжает с того же места
 В Temporal UI видны переходы между шагами


Что НЕ входит в этот этап

Proactive messages (1.2)
UI прогресса (1.2)
Widget для brain_dump (1.5)
Промпты — только логика (промпты будут в 1.3-1.4)


Зависимости

Требуется: работающая инфраструктура из 1.0 ✅
Требуется: все 4 агента созданы ✅
Требуется: Mem0 интеграция ✅
Требуется: inbox_items коллекция в БД ✅